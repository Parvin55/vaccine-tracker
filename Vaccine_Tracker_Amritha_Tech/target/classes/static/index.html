<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Dashboard</title>
<link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div id="app">
    <header>
      <div class="username">Hi, {{ username }}</div>
      <button class="logout-btn" @click="logout">Logout</button>
    </header>

    <nav>
      <!-- <button class="menu-btn" @click="navigateToAddRecord">Add Record</button> -->
     <!--<button class="menu-btn" @click="navigateToReport">Report</button>  -->
    </nav>

    <main id="add-record">
      <!-- Your form and table here -->
      <h2>Add Immunization Record</h2>

      <label for="vaccine-select">Select Vaccine:</label>
      <select id="vaccine-select" v-model="selectedVaccineId">
        <option disabled value="">-- Select Vaccine --</option>
        <option v-for="vaccine in vaccines" :key="vaccine.vaccineId" :value="vaccine.vaccineId">
  		{{ vaccine.name }}
		</option>
      </select>

      <label for="dose-date">Dose Date:</label>
      <input type="date" id="dose-date" v-model="doseDate" />

      <button class="save-btn" @click="saveRecord" :disabled="!canSave">
  		{{ editRecordId ? 'Update' : 'Save' }}
		</button>

      <table v-if="records.length > 0" aria-label="Immunization Records">
        <thead>
          <tr>
            <th>SI No.</th>
            <th>Vaccine Name</th>
            <th>Dose Date</th>
            <th>Next Due Date</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(record, index) in records" :key="record.id">
            <td>{{ index + 1 }}</td>
            <td>{{ record.vaccine.name }}</td>
            <td>{{ formatDate(record.doseDate) }}</td>
            <td>{{ formatDate(record.nextDueDate) }}</td>
            <td :class="statusClass(record.status)">{{ record.status }}</td>
            <td>
               <button class="action-btn edit-btn" @click="startEdit(record)">Edit</button>
              <button class="action-btn delete-btn" @click="deleteRecord(record.immId)">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </main>
  </div>

  
  <!-- Load Vue and Axios first -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          username: '',
          userId: null,
          vaccines: [],
          records: [],
          selectedVaccineId: '',
          doseDate: '',
          editRecordId: null,
        };
      },
      computed: {
        canSave() {
          return this.selectedVaccineId && this.doseDate;
        }
      },
      methods: {
        logout() {
          localStorage.clear();
          window.location.href = 'login.html';
        },
        navigateToAddRecord() {
          window.location.href = 'add-record.html';
        },
        navigateToReport() {
          window.location.href = 'report.html';
        },
        fetchUserName() {
        	if (!this.userId) {
        	    console.log('No userId found, redirecting...');
        	    window.location.href = 'login.html'; 
        	    return;
        	  }
        	  axios.get(`http://localhost:8080/api/users/${this.userId}`)
        	    .then(response => {
        	      console.log('User data:', response.data);
        	      this.username = response.data.name;
        	    })
        	    .catch(error => {
        	      console.error('Failed to fetch username:', error);
        	      window.location.href = 'login.html';
        	    });
        },
        fetchVaccines() {
          axios.get('http://localhost:8080/api/vaccines')
            .then(res => {
            	console.log('Vaccines:', res.data);
              this.vaccines = res.data;
            })
            .catch(err => {
              console.error('Failed to fetch vaccines:', err);
              alert('Failed to load vaccines. Please try again.');
            });
        },
        fetchRecords() {
        	 if (!this.userId) return;
        	  axios.get(`http://localhost:8080/api/immunizations/user/${this.userId}`)
        	    .then(res => {
        	      console.log('Fetched records:', res.data);
        	      this.records = res.data;
        	    })
        	    .catch(err => {
        	      console.error('Failed to fetch records:', err);
        	    });
        },
        
        startEdit(record) {
            this.editRecordId = record.immId;
            this.selectedVaccineId = record.vaccine.vaccineId;
            this.doseDate = record.doseDate;
          },

          saveRecord() {
            if (!this.canSave) return;

            const payload = {
              userId: this.userId,
              vaccineId: this.selectedVaccineId,
              doseDate: this.doseDate,
            };

            if (this.editRecordId) {
              axios.put(`http://localhost:8080/api/immunizations/${this.editRecordId}`, payload)
                .then(() => {
                  alert('Record updated successfully.');
                  this.clearForm();
                  this.fetchRecords();
                  this.editRecordId = null;
                })
                .catch(err => {
                  console.error('Failed to update record:', err);
                  alert('Failed to update record. Please try again.');
                });
            } else {
              axios.post('http://localhost:8080/api/immunizations', payload)
                .then(() => {
                  alert('Record saved successfully.');
                  this.clearForm();
                  this.fetchRecords();
                })
                .catch(err => {
                  console.error('Failed to save record:', err);
                  alert('Failed to save record. Please try again.');
                });
            }
          },

          deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;
            axios.delete(`http://localhost:8080/api/immunizations/${id}`)
              .then(() => {
                this.records = this.records.filter(r => r.immId !== id);
              })
              .catch(err => {
                console.error('Failed to delete record:', err);
                alert('Failed to delete record.');
              });
          },
        formatDate(dateStr) {
          if (!dateStr) return '-';
          return new Date(dateStr).toLocaleDateString();
        },
        statusClass(status) {
          switch (status) {
            case 'OVERDUE': return 'text-red';
            case 'DUE TODAY': return 'text-orange';
            case 'UPCOMING': return 'text-green';
            default: return '';
          }
        },
        clearForm() {
          this.selectedVaccineId = '';
          this.doseDate = '';
          this.editRecordId = null;
        },
        checkLogin() {
          this.userId = localStorage.getItem('userId');
          if (!this.userId) {
            window.location.href = 'login.html';
          }
        }
      },
      mounted() {
        this.checkLogin();
        this.fetchUserName();
        this.fetchVaccines();
        this.fetchRecords();
      }
    }).mount('#app');
  </script>
  
</body>
</html>
